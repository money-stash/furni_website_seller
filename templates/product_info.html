<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lotos – Product</title>

  <link href="{{url_for('static', filename='css/bootstrap.min.css')}}" rel="stylesheet">
  <link href="{{url_for('static', filename='css/style.css')}}" rel="stylesheet">
  <link href="{{url_for('static', filename='css/product-gallery.css')}}" rel="stylesheet">
</head>
<body>

  <!-- Start Header/Navigation -->
    <nav class="custom-navbar navbar navbar-expand-md navbar-dark bg-dark" aria-label="Furni navigation bar">
      <div class="container position-relative d-flex justify-content-between align-items-center">
        <a class="navbar-brand" href="{{ url_for('index') }}">Lotos<span>.</span></a>

        <!-- Иконки профиля и корзины всегда сверху -->
        <ul class="custom-navbar-cta navbar-nav mb-2 mb-md-0 d-flex flex-row profile-cart-icons">
          <li class="nav-item me-3">
            <a class="nav-link" href="{{ url_for('profile') }}">
              <img src="{{url_for('static', filename='images/user.svg')}}" />
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('cart') }}">
              <img src="{{url_for('static', filename='images/cart.svg')}}" />
            </a>
          </li>
        </ul>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsFurni" aria-controls="navbarsFurni" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarsFurni">
          <ul class="custom-navbar-nav navbar-nav ms-auto mb-2 mb-md-0">
            <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}">Головна</a></li>
            <li class="active"><a class="nav-link" href="{{ url_for('categories_view') }}">Магазин</a></li>
            <li><a class="nav-link" href="{{ url_for('about') }}">Про нас</a></li>
            <li><a class="nav-link" href="{{ url_for('services') }}">Послуги</a></li>
            <li><a class="nav-link" href="{{ url_for('contact') }}">Зв'яжіться з нами</a></li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- End Header/Navigation -->

  <!-- HERO -->
  <div class="hero small-hero">
    <div class="container">
      <div class="row">
        <div class="col">
          <div class="intro-excerpt">
            <!-- Кнопка "Назад" сверху -->
            <div class="mb-3">
              <button onclick="history.back()" class="btn btn-outline-light btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Повернутися назад
              </button>
            </div>
            
            <h1>{{ product.name }}</h1>
            
            <!-- Breadcrumb навігація -->
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb breadcrumb-custom">
                <li class="breadcrumb-item">
                  <a href="{{ url_for('index') }}">Додому</a>
                </li>
                <li class="breadcrumb-item">
                  <a href="{{ url_for('categories_view') }}">Категорії</a>
                </li>
                {% if product.category %}
                <li class="breadcrumb-item">
                  <a href="{{ url_for('shop', category=product.category.name|lower) }}">{{ product.category.name }}</a>
                </li>
                {% endif %}
                <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
              </ol>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- PRODUCT CARD -->
  <div class="pg-product-section">
    <div class="container">
      <div class="row g-4">

        <!-- LEFT: Галерея с изолированными классами -->
        <div class="col-12 col-md-6">
          <div class="pg-container">
            <div class="pg-gallery-wrapper" role="region" aria-label="Product gallery">
              <!-- Колонка миниатюр -->
              <div class="pg-thumbs-column" id="pgThumbsColumn">
                {% for image in product.images %}
                  <img class="pg-thumb {% if loop.first %}pg-active{% endif %}" 
                      src="{{ url_for('static', filename=image.path[7:] if image.path.startswith('static/') else image.path) }}" 
                      data-large="{{ url_for('static', filename=image.path[7:] if image.path.startswith('static/') else image.path) }}" 
                      alt="Product view {{ loop.index }}" 
                      tabindex="0" 
                      loading="lazy">
                {% endfor %}
              </div>

              <!-- Основное изображение -->
              <div class="pg-main-image-area">
                <img id="pgMainImage" 
                src="{{ url_for('static', filename=product.images[0].path[7:] if product.images|length > 0 and product.images[0].path.startswith('static/') else product.images[0].path) }}" 
                alt="Main product image" 
                class="pg-main-image" 
                loading="lazy"
                tabindex="0">
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT: детали продукта -->
        <div class="col-12 col-md-6">
          <div class="pg-details-card">
            <h2 class="product-title">{{ product.name }}</h2>
            <p class="product-sku text-muted">SKU: {{ product.id }}</p>

            <div class="price-row d-flex align-items-end gap-3 mb-3">
              <div>
                {% if product.discount_percent %}
                  <div class="product-price-big text-success">₴{{ '%.2f' % (product.price * (1 - product.discount_percent / 100)) }}</div>
                  <div class="product-price-old text-muted text-danger"><s>₴{{ '%.2f' % product.price }}</s></div>
                {% else %}
                  <div class="product-price-big">₴{{ '%.2f' % product.price }}</div>
                {% endif %}
              </div>
              <div class="ms-auto">
                <div class="rating small text-muted">★★★★☆ <span class="ms-1">({{ product.reviews_count if product.reviews_count is defined else 0 }})</span></div>
              </div>
            </div>

            <div class="product-actions-block mb-4">
              <div class="input-group quantity-group mb-3" style="max-width:220px;">
                <button class="btn btn-outline-secondary qty-decrease" type="button">−</button>
                <input id="qtyInput" type="number" class="form-control text-center" value="1" min="1" step="1">
                <button class="btn btn-outline-secondary qty-increase" type="button">+</button>
              </div>

              <div class="d-flex gap-2">
                <button id="buyBtn" class="btn btn-primary btn-lg">Купити зараз</button>
                <button id="addToCartBtn" class="btn btn-outline-secondary">Додати до кошика</button>
              </div>
            </div>

            <hr>

            <h5>Опис продукту</h5>
            <p class="small text-muted mb-3" style="white-space: pre-wrap;">{{ product.description if product.description else '' }}</p>

            <h5>Специфікації</h5>
            <table class="table table-sm specs-table mb-0">
              <tbody>
                {% if product.attributes and product.attributes.strip() %}
                  {% for attr in product.attributes.split(';') %}
                    {% if attr.strip() %}
                      <tr>
                        <td>{{ attr.strip() }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <tr>
                    <td class="text-muted text-center">
                      <em>Специфікації відсутні</em>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>

          </div>
        </div>

      </div> <!-- row -->
    </div> <!-- container -->
  </div> <!-- section -->

  <!-- Start Footer Section -->
    <footer class="footer-section">
      <div class="container relative">
        <div class="row g-5 mb-5">
          <div class="col-lg-4">
            <div class="mb-4 footer-logo-wrap">
              <a href="#" class="footer-logo">Lotos<span>.</span></a>
            </div>
            <p class="mb-4">
              Lotos — це більше, ніж просто магазин меблів. Ми створюємо простір, у якому вам хочеться жити, відпочивати й надихатись.
            </p>

            <ul class="list-unstyled custom-social">
              <li>
                <a href="https://www.instagram.com/lotos_mebel_ua"><span class="fa fa-brands fa-instagram"></span></a>
              </li>
            </ul>
          </div>

          <div class="col-lg-8">
            <div class="row links-wrap">
              <div class="col-6 col-sm-6 col-md-3">
                <ul class="list-unstyled">
                  <li><a href="#">Про нас</a></li>
                  <li><a href="#">Послуги</a></li>
                  <li><a href="#">Зв'яжіться з нами</a></li>
                </ul>
              </div>

              <div class="col-6 col-sm-6 col-md-3">
                <ul class="list-unstyled">
                  <li><a href="#">Підтримка</a></li>
                </ul>
              </div>

              <div class="col-6 col-sm-6 col-md-3">
                <ul class="list-unstyled">
                  <li><a href="#">Наша команда</a></li>
                  <li><a href="{{ url_for('terms') }}"> Угода користувача </a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="border-top copyright">
          <div class="row pt-4">
            <div class="col-lg-6">
              <p class="mb-2 text-center text-lg-start">
                Copyright &copy;
                <script>
                  document.write(new Date().getFullYear());
                </script>
                . All Rights Reserved. &mdash; Designed with love
              </p>
            </div>

            <div class="col-lg-6 text-center text-lg-end">
              <ul class="list-unstyled d-inline-flex ms-auto">
                <li><a href="{{ url_for('terms') }}"> Угода користувача </a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </footer>
    <!-- End Footer Section -->

  <script src="js/bootstrap.bundle.min.js"></script>

  <script>
  (function () {
    // Галерея с новыми классами
    const mainImg = document.getElementById('pgMainImage');
    const thumbs = Array.from(document.querySelectorAll('.pg-thumb'));

    if (mainImg && thumbs.length > 0) {
      // Устанавливаем начальное изображение
      const first = thumbs.find(t => t.classList.contains('pg-active')) || thumbs[0];
      if (first) {
        first.classList.add('pg-active');
        mainImg.src = first.getAttribute('data-large') || first.src;
      }

      // Обработка кликов и клавиатуры
      thumbs.forEach(t => {
        const activate = () => {
          thumbs.forEach(x => x.classList.remove('pg-active'));
          t.classList.add('pg-active');
          const large = t.getAttribute('data-large') || t.src;
          mainImg.src = large;
          mainImg.alt = t.alt || 'Product image';
        };

        t.addEventListener('click', activate);

        t.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter' || ev.key === ' ' || ev.key === 'Spacebar') {
            ev.preventDefault();
            activate();
          }
          if (ev.key === 'ArrowDown' || ev.key === 'ArrowRight') {
            ev.preventDefault();
            const next = t.nextElementSibling || thumbs[0];
            if (next && typeof next.focus === 'function') next.focus();
          }
          if (ev.key === 'ArrowUp' || ev.key === 'ArrowLeft') {
            ev.preventDefault();
            const prev = t.previousElementSibling || thumbs[thumbs.length - 1];
            if (prev && typeof prev.focus === 'function') prev.focus();
          }
        });
      });
    }

    // Контроль количества
    const qtyInput = document.getElementById('qtyInput');
    const incBtn = document.querySelector('.qty-increase');
    const decBtn = document.querySelector('.qty-decrease');

    if (incBtn && qtyInput) {
      incBtn.addEventListener('click', () => {
        qtyInput.value = Math.max(1, parseInt(qtyInput.value || '1') + 1);
      });
    }
    if (decBtn && qtyInput) {
      decBtn.addEventListener('click', () => {
        qtyInput.value = Math.max(1, parseInt(qtyInput.value || '1') - 1);
      });
    }

    if (qtyInput) {
      qtyInput.addEventListener('input', () => {
        if (qtyInput.value === '') return;
        let v = parseInt(qtyInput.value || '1');
        if (isNaN(v) || v < 1) v = 1;
        qtyInput.value = v;
      });
    }
  })();


  // плавное изображение
  const mainImg = document.getElementById('pgMainImage');

    function changeMainImage(src, alt) {
    mainImg.style.opacity = 0;
    setTimeout(() => {
        mainImg.src = src;
        mainImg.alt = alt || 'Product image';
        mainImg.style.opacity = 1;
    }, 150); // полупериод для плавного перехода
    }

    thumbs.forEach(t => {
    const activate = () => {
        thumbs.forEach(x => x.classList.remove('pg-active'));
        t.classList.add('pg-active');
        const large = t.getAttribute('data-large') || t.src;
        changeMainImage(large, t.alt);
    };

    t.addEventListener('click', activate);
    t.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ' || ev.key === 'Spacebar') {
        ev.preventDefault();
        activate();
        }
        if (ev.key === 'ArrowDown' || ev.key === 'ArrowRight') {
        ev.preventDefault();
        const next = t.nextElementSibling || thumbs[0];
        if (next && typeof next.focus === 'function') next.focus();
        }
        if (ev.key === 'ArrowUp' || ev.key === 'ArrowLeft') {
        ev.preventDefault();
        const prev = t.previousElementSibling || thumbs[thumbs.length - 1];
        if (prev && typeof prev.focus === 'function') prev.focus();
        }
    });
    });

  </script>
  <script>
(function () {
  const qtyInput = document.getElementById('qtyInput');
  const incBtn = document.querySelector('.qty-increase');
  const decBtn = document.querySelector('.qty-decrease');

  if (incBtn && qtyInput) {
    incBtn.addEventListener('click', () => {
      qtyInput.value = Math.max(1, parseInt(qtyInput.value || '1') + 1);
    });
  }
  if (decBtn && qtyInput) {
    decBtn.addEventListener('click', () => {
      qtyInput.value = Math.max(1, parseInt(qtyInput.value || '1') - 1);
    });
  }
  if (qtyInput) {
    qtyInput.addEventListener('input', () => {
      if (qtyInput.value === '') return;
      let v = parseInt(qtyInput.value || '1');
      if (isNaN(v) || v < 1) v = 1;
      qtyInput.value = v;
    });
  }

  const addToCartBtn = document.getElementById('addToCartBtn');
  const buyBtn = document.getElementById('buyBtn');

  // получаем product_id из шаблона Flask
  const productId = {{ product.id }};

  async function addToCart(quantity = 1, redirectToCheckout = false) {
    try {
      const response = await fetch('/api/cart/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ product_id: productId, quantity })
      });
      const result = await response.json();

      if (result.success) {
        alert(result.message); // можно заменить на красивое уведомление
        if (redirectToCheckout) {
          window.location.href = '/cart'; // редирект на страницу корзины
        }
      } else {
        alert(result.message || 'Ошибка при добавлении в корзину');
      }
    } catch (err) {
      console.error(err);
      alert('Сервер недоступен, попробуйте позже.');
    }
  }

  if (addToCartBtn) {
    addToCartBtn.addEventListener('click', () => {
      const qty = parseInt(qtyInput.value || '1');
      addToCart(qty, false);
    });
  }

  if (buyBtn) {
    buyBtn.addEventListener('click', () => {
      const qty = parseInt(qtyInput.value || '1');
      addToCart(qty, true); // после добавления редирект на корзину
    });
  }
})();
</script>


</body>
</html>