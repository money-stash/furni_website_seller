<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="author" content="Untree.co">
  <link rel="shortcut icon" href="favicon.png">

  <meta name="description" content="" />
  <meta name="keywords" content="bootstrap, bootstrap4" />

  <link href="{{url_for('static', filename='css/bootstrap.min.css')}}" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link href="{{url_for('static', filename='css/tiny-slider.css')}}" rel="stylesheet">
  <link href="{{url_for('static', filename='css/style.css')}}" rel="stylesheet">
  <title>HOGAR — Магазин</title>
</head>

<body>
  <nav class="custom-navbar navbar navbar-expand-md navbar-dark bg-dark" arial-label="Furni navigation bar">
    <div class="container">
      <a class="navbar-brand" href="{{ url_for('index') }}">Furni<span>.</span></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsFurni" aria-controls="navbarsFurni" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsFurni">
        <ul class="custom-navbar-nav navbar-nav ms-auto mb-2 mb-md-0">
          <li class="nav-item "><a class="nav-link" href="{{ url_for('index') }}">Головна</a></li>
          <li class="active"><a class="nav-link" href="{{ url_for('shop') }}">Магазин</a></li>
          <li><a class="nav-link" href="{{ url_for('about') }}">Про нас</a></li>
          <li><a class="nav-link" href="{{ url_for('services') }}">Послуги</a></li>
          <li><a class="nav-link" href="{{ url_for('contact') }}">Зв'яжіться з нами</a></li>
        </ul>

        <ul class="custom-navbar-cta navbar-nav mb-2 mb-md-0 ms-5">
          <li><a class="nav-link" href="{{ url_for('profile') }}"><img src="{{url_for('static', filename='images/user.svg')}}"></a></li>
          <li><a class="nav-link" href="{{ url_for('cart') }}"><img src="{{url_for('static', filename='images/cart.svg')}}"></a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <div class="hero">
    <div class="container">
      <div class="row justify-content-between">
        <div class="col-lg-5">
          <div class="intro-excerpt">
            <h1>Магазин</h1>
          </div>
        </div>
        <div class="col-lg-7"></div>
      </div>
    </div>
  </div>

  <!-- Controls: category + search + price range + sort -->
  <div class="untree_co-section product-section before-footer-section">
    <div class="container">
      <div class="row mb-4 align-items-center controls-row">
        <div class="col-12 col-md-3 mb-2 mb-md-0">
          <select id="categorySelect" class="form-select">
            <option value="all">Усі категорії</option>
            {% for cat in categories %}
            <option value="{{ cat.name|lower }}">{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-4 mb-2 mb-md-0">
          <input id="searchInput" class="form-control" type="search" placeholder="Пошук товарів, наприклад, 'Nordic'">
        </div>

        <div class="col-6 col-md-2 mb-2 mb-md-0">
          <input id="minPrice" class="form-control" type="number" placeholder="Мiн ₴" min="0" step="1">
        </div>

        <div class="col-6 col-md-2 mb-2 mb-md-0">
          <input id="maxPrice" class="form-control" type="number" placeholder="Макс ₴" min="0" step="1">
        </div>

        <div class="col-12 col-md-1 text-md-end mt-2 mt-md-0">
          <select id="sortSelect" class="form-select" title="Sort by price">
            <option value="none">Сортувати</option>
            <option value="price-asc">Ціна ↑</option>
            <option value="price-desc">Ціна ↓</option>
          </select>
        </div>

        <div class="col-12 text-end mt-2">
          <small class="text-muted" id="resultsCount">Показано всі товари</small>
        </div>
      </div>

      <div class="row" id="productsRow">
        {% if products and products|length > 0 %}
          {% for p in products %}
            {% set img_src = p.preview %}
            {% if (not img_src) and p.images and p.images|length > 0 %}
              {% set img_src = p.images[0].path %}
            {% endif %}
            {% set discount = p.discount_percent or 0 %}
            {% set price_with_discount = (p.price * (1 - (discount / 100.0))) if discount else p.price %}

            <div class="col-12 col-md-4 col-lg-3 mb-5 product-col" data-category="{{ (p.category.name if p.category else '')|lower }}" data-price="{{ '%.2f' % price_with_discount }}">
              <a class="product-item" href="{{ url_for('product_info', product_id=p.id) }}">
                {% if img_src %}
                  <img src="{{ url_for('static', filename=img_src[7:] if img_src.startswith('static/') else img_src) }}" class="img-fluid product-thumbnail" alt="{{ p.name }}">
                {% endif %}
                <h3 class="product-title">{{ p.name }}</h3>
                {% if discount and discount|float > 0 %}
                  <strong class="product-price" style="color:red; text-decoration:line-through;">₴{{ '%.2f' % p.price }}</strong>
                  <div class="product-discount"> → <strong style="color:green;">₴{{ '%.2f' % price_with_discount }}</strong> <small class="text-muted">({{ discount }}% off)</small></div>
                {% else %}
                  <strong class="product-price" style="color:black;">₴{{ '%.2f' % p.price }}</strong>
                {% endif %}
                <span class="icon-cross"><img src="{{ url_for('static', filename='images/cross.svg') }}" class="img-fluid"></span>
              </a>
            </div>
          {% endfor %}
        {% else %}
          <div class="col-12">
            <p class="text-center">Товари не знайдені.</p>
          </div>
        {% endif %}

      </div> <!-- end row -->
    </div> <!-- end container -->
  </div> <!-- end section -->

  <!-- Start Footer Section -->
    <footer class="footer-section">
      <div class="container relative">
        <div class="sofa-img">
          <img src="{{url_for('static', filename='images/sofa.png')}}" alt="Image" class="img-fluid" />
        </div>

        

        <div class="row g-5 mb-5">
          <div class="col-lg-4">
            <div class="mb-4 footer-logo-wrap">
              <a href="#" class="footer-logo">Hogar<span>.</span></a>
            </div>
            <p class="mb-4">
              Hogar — це більше, ніж просто магазин меблів. Ми створюємо простір, у якому вам хочеться жити, відпочивати й надихатись.
            </p>

            <ul class="list-unstyled custom-social">
              <li>
                <a href="#"><span class="fa fa-brands fa-facebook-f"></span></a>
              </li>
              <li>
                <a href="#"><span class="fa fa-brands fa-instagram"></span></a>
              </li>
            </ul>
          </div>

          <div class="col-lg-8">
            <div class="row links-wrap">
              <div class="col-6 col-sm-6 col-md-3">
                <ul class="list-unstyled">
                  <li><a href="#">Про нас</a></li>
                  <li><a href="#">Послуги</a></li>
                  <li><a href="#">Зв'яжіться з нами</a></li>
                </ul>
              </div>

              <div class="col-6 col-sm-6 col-md-3">
                <ul class="list-unstyled">
                  <li><a href="#">Підтримка</a></li>
                </ul>
              </div>

              <div class="col-6 col-sm-6 col-md-3">
                <ul class="list-unstyled">
                  <li><a href="#">Наша команда</a></li>
                  <li><a href="#">Політика конфіденційності</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="border-top copyright">
          <div class="row pt-4">
            <div class="col-lg-6">
              <p class="mb-2 text-center text-lg-start">
                Copyright &copy;
                <script>
                  document.write(new Date().getFullYear());
                </script>
                . All Rights Reserved. &mdash; Designed with love by
                <a href="https://t.me/makson8567">tg: makson8567</a> Distributed By
				<a href="https://t.me/makson8567">tg: makson8567</a>
                <!-- License information: https://untree.co/license/ -->
              </p>
            </div>

            <div class="col-lg-6 text-center text-lg-end">
              <ul class="list-unstyled d-inline-flex ms-auto">
                <li class="me-4"><a href="#">Terms &amp; Conditions</a></li>
                <li><a href="#">Політика конфіденційності</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </footer>
    <!-- End Footer Section -->

  <script src="{{url_for('static', filename='js/bootstrap.bundle.min.js')}}"></script>
  <script src="{{url_for('static', filename='js/tiny-slider.js')}}"></script>

  <!-- Фильтрация + поиск + price range + сортировка -->
  <script>
    (function () {
      const select = document.getElementById('categorySelect');
      const input = document.getElementById('searchInput');
      const minInput = document.getElementById('minPrice');
      const maxInput = document.getElementById('maxPrice');
      const sortSelect = document.getElementById('sortSelect');
      const productsRow = document.getElementById('productsRow');
      let productCols = Array.from(document.querySelectorAll('.product-col'));
      const resultsCount = document.getElementById('resultsCount');

      // helper: normalize text
      function normalize(s) { return (s || '').toString().toLowerCase().trim(); }

      // helper: read price from data-price attribute (number) or from .product-price text
      function getPriceFromCol(col) {
        const dp = col.getAttribute('data-price');
        if (dp !== null) {
          const n = parseFloat(dp);
          return isNaN(n) ? null : n;
        }
        const el = col.querySelector('.product-price');
        if (!el) return null;
        const txt = el.textContent.replace(/[^\d.,]/g, '').replace(',', '.');
        const n = parseFloat(txt);
        return isNaN(n) ? null : n;
      }

      function updateResultsCount(visible, total) {
        if (visible === total) {
          resultsCount.textContent = 'Показано всі товари';
        } else {
          resultsCount.textContent = `Показано ${visible} з ${total}`;
        }
      }

      // filter function returns array of visible cols (DOM elements)
      function filterProducts() {
        const category = select.value;
        const q = normalize(input.value);
        const min = (minInput.value !== '') ? parseFloat(minInput.value) : null;
        const max = (maxInput.value !== '') ? parseFloat(maxInput.value) : null;

        const visibleCols = [];

        productCols.forEach(col => {
          const cat = col.getAttribute('data-category') || '';
          const titleEl = col.querySelector('.product-title');
          const title = normalize(titleEl ? titleEl.textContent : '');
          const price = getPriceFromCol(col);

          const matchesCategory = (category === 'all') || (cat === category);
          const matchesQuery = q === '' || title.indexOf(q) !== -1;
          const matchesMin = (min === null) || (price !== null && price >= min);
          const matchesMax = (max === null) || (price !== null && price <= max);

          if (matchesCategory && matchesQuery && matchesMin && matchesMax) {
            col.style.display = '';
            visibleCols.push(col);
          } else {
            col.style.display = 'none';
          }
        });

        // после фильтрации — применим сортировку к видимым карточкам
        sortAndRender(visibleCols);

        updateResultsCount(visibleCols.length, productCols.length);
      }

      // сортировка — принимает массив видимых колонок и переставляет их в DOM
      function sortAndRender(visibleCols) {
        const sortVal = sortSelect.value;
        if (sortVal === 'price-asc' || sortVal === 'price-desc') {
          visibleCols.sort((a, b) => {
            const pa = getPriceFromCol(a) ?? 0;
            const pb = getPriceFromCol(b) ?? 0;
            return sortVal === 'price-asc' ? (pa - pb) : (pb - pa);
          });
        } else {
          // если "none" — оставляем порядок, как в productCols (исходный)
          visibleCols.sort((a, b) => productCols.indexOf(a) - productCols.indexOf(b));
        }

        // рендерим: сначала очищаем контейнер, затем добавляем сначала видимые (в отсортированном порядке),
        // затем оставшиеся скрытые (чтобы не ломать DOM для остального).
        const hiddenCols = productCols.filter(c => c.style.display === 'none');
        productsRow.innerHTML = '';
        visibleCols.forEach(c => productsRow.appendChild(c));
        hiddenCols.forEach(c => productsRow.appendChild(c));
      }

      // debounce helper
      function debounce(fn, ms) {
        let t;
        return function () {
          clearTimeout(t);
          const args = arguments;
          t = setTimeout(() => fn.apply(this, args), ms);
        };
      }

      // events
      select.addEventListener('change', filterProducts);
      input.addEventListener('input', debounce(filterProducts, 200));
      minInput.addEventListener('input', debounce(filterProducts, 200));
      maxInput.addEventListener('input', debounce(filterProducts, 200));
      sortSelect.addEventListener('change', function () {
        // когда меняется сортировка — пересортируем видимые элементы без переставления фильтров
        const visible = Array.from(document.querySelectorAll('.product-col')).filter(c => c.style.display !== 'none');
        sortAndRender(visible);
      });

      // init: cache initial order of productCols from DOM
      productCols = Array.from(document.querySelectorAll('.product-col'));
      filterProducts();
    })();
  </script>

  <script src="{{url_for('static', filename='js/custom.js')}}"></script>
</body>
</html>
