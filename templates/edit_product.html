<!DOCTYPE html>

<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактирование товара</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-panel-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-products.css') }}">
    <style>
        .form-group { margin-bottom: 15px; }
        .form-group label { font-weight: bold; display: block; margin-bottom: 5px; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;
        }
        .preview-img { max-height: 150px; margin-bottom: 10px; display:block; }
        .additional-img { max-height: 100px; margin: 5px; display: block; }
        .delete-img { background: red; color: white; border: none; cursor: pointer; border-radius: 50%; width: 22px; height: 22px; line-height: 20px; text-align: center; font-size: 14px; }

        .attribute-item { display: flex; gap: 8px; margin-bottom: 6px; position: relative; align-items: center; }
        .attribute-item input { flex: 1; padding-right: 36px; }
        .attribute-item .delete-img { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); }

        .image-item { position: relative; display: inline-block; margin: 5px; }
        .image-item .additional-img { max-height: 100px; display: block; }
        .image-item .delete-img { position: absolute; top: 4px; right: 4px; }

        .addon-list { border: 1px solid #e0e0e0; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .addon-category { border: 1px dashed #ddd; padding: 10px; margin-bottom: 10px; border-radius: 6px; position: relative; }
        .addon-category .remove-addon { position: absolute; top: 8px; right: 8px; background:#c0392b; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:4px; }
        .addon-category h4 { margin: 0 0 8px 0; }
        .addon-items { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px; }
        .addon-item { position: relative; display:inline-block; border: 1px solid #e0e0e0; padding: 8px; border-radius: 6px; background: #f9f9f9; }
        .addon-item img { max-height:80px; display:block; margin-bottom: 4px; }
        .addon-item .delete-img { position:absolute; top:4px; right:4px; }
        .addon-item input[type="text"] { width: 100%; padding: 4px; font-size: 12px; margin-top: 4px; }
        .btn-small { padding:6px 10px; border-radius:6px; cursor:pointer; }
        
        .new-addon-items-preview { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .new-addon-item-preview { border: 1px solid #e0e0e0; padding: 8px; border-radius: 6px; background: #f9f9f9; display: inline-block; }
        .new-addon-item-preview img { max-height: 80px; display: block; margin-bottom: 4px; }
        .new-addon-item-preview input { width: 150px; padding: 4px; font-size: 12px; }
    </style>

</head>
<body>
<nav class="admin-nav">
    <a href="{{ url_for('admin.admin_panel') }}" class="nav-btn">Головне управління</a>
    <a href="{{ url_for('admin.admin_products') }}" class="nav-btn">Управління товарами</a>
    <a href="{{ url_for('admin.admin_settings') }}" class="nav-btn">Налаштування сайту</a>
</nav>

<div class="admin-container">
    <h1>Редагування товару</h1>

<form id="edit-product-form" method="POST" action="{{ url_for('products.update_product', product_id=product.id) }}" enctype="multipart/form-data">
    <input type="hidden" name="product_id" value="{{ product.id }}">

    <div class="form-group">
        <label for="product-name">Назва товару</label>
        <input type="text" name="product-name" id="product-name" value="{{ product.name }}">
    </div>

    <div class="form-group">
        <label for="product-category">Категорія</label>
        <select name="product-category" id="product-category">
            <option value="">-- Без категорії --</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}" {% if product.category and product.category.id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="product-description">Опис</label>
        <textarea name="product-description" id="product-description" rows="4">{{ product.description }}</textarea>
    </div>

    <div class="form-group">
        <label for="product-price">Ціна</label>
        <input type="number" step="0.01" name="product-price" id="product-price" value="{{ product.price }}">
    </div>

    <div class="form-group">
        <label for="discount-percent">Знижка %</label>
        <input type="number" step="0.01" name="discount_percent" id="discount-percent" value="{{ product.discount_percent }}">
    </div>

    <div class="form-group">
        <label for="price-with-discount">Ціна зі знижкою</label>
        <input type="text" id="price-with-discount" readonly value="" />
    </div>

    <div class="form-group">
        <label>Превью</label>
        {% if product.preview %}
            <img src="{{ url_for('static', filename=product.preview[7:] if product.preview.startswith('static/') else product.preview) }}" class="preview-img" id="current-preview">
            <label><input type="checkbox" name="delete_preview" value="1"> Видалити поточний превью</label>
        {% endif %}
        <input type="file" name="product-preview" accept="image/*">
    </div>

    <div class="form-group">
        <label>Додаткові зображення</label>
        <div id="additional-images">
            {% for img in product.images %}
                <div class="image-item">
                    <img src="{{ url_for('static', filename=img.path[7:] if img.path.startswith('static/') else img.path) }}" class="additional-img">
                    <button type="button" class="delete-img">&times;</button>
                    <input type="hidden" name="existing_images" value="{{ img.path }}">
                </div>
            {% endfor %}
        </div>
        <input type="file" name="product-images" multiple accept="image/*">
    </div>

    <div class="form-group">
        <label>Атрибути</label>
        <div id="attributes">
            {% for attr in attributes %}
                <div class="attribute-item">
                    <input type="text" name="attribute" value="{{ attr }}">
                    <button type="button" class="delete-img">&times;</button>
                </div>
            {% endfor %}
        </div>
        <button type="button" id="add-attribute" class="btn-small">Додати атрибут</button>
    </div>

    <div class="form-group">
        <label>Додаткові категорії (Add-on)</label>
        <div id="addon-categories" class="addon-list">
            {% for addon in product.addon_categories %}
                <div class="addon-category addon-category-existing" data-addon-id="{{ addon.id }}">
                    <button type="button" class="remove-addon">Видалити</button>
                    <h4>Додаткова категорія</h4>
                    <input type="hidden" name="existing_addon_category_ids" value="{{ addon.id }}">
                    <div class="form-group">
                        <label>Назва</label>
                        <input type="text" name="addon_name_{{ addon.id }}" value="{{ addon.name }}">
                    </div>
                    <div class="form-group">
                        <label>Ціна</label>
                        <input type="number" step="0.01" name="addon_price_{{ addon.id }}" value="{{ addon.price }}">
                    </div>
                    <div class="form-group">
                        <label>Елементи</label>
                        <div class="addon-items" data-addon-id="{{ addon.id }}">
                            {% for item in addon.items %}
                                <div class="addon-item">
                                    {% if item.image_path %}
                                    <img src="{{ url_for('static', filename=item.image_path[7:] if item.image_path.startswith('static/') else item.image_path) }}">
                                    {% endif %}
                                    <input type="text" name="addon_item_name_{{ addon.id }}_{{ item.id }}" value="{{ item.name }}" placeholder="Назва елемента">
                                    <button type="button" class="delete-img">&times;</button>
                                    <input type="hidden" name="existing_addon_item_ids_{{ addon.id }}" value="{{ item.id }}">
                                </div>
                            {% endfor %}
                        </div>
                        <input type="file" name="addon_items_{{ addon.id }}" multiple accept="image/*" class="addon-file-input" data-addon-id="{{ addon.id }}">
                        <div class="new-addon-items-preview" data-addon-id="{{ addon.id }}"></div>
                    </div>
                </div>
            {% endfor %}

            <div id="new-addons-container"></div>

            <button type="button" id="add-addon" class="btn-small">Додати доп.категорію</button>
        </div>
    </div>

    <button type="submit" class="btn">Зберегти зміни</button>
</form>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('edit-product-form');

    const priceInput = document.getElementsByName('product-price')[0];
    const discountInput = document.getElementsByName('discount_percent')[0];
    const priceWithDiscountEl = document.getElementById('price-with-discount');

    function formatMoney(val) {
        return Number(val).toFixed(2);
    }

    function updatePriceWithDiscount() {
        const price = parseFloat(priceInput ? priceInput.value : 0) || 0;
        const discount = parseFloat(discountInput ? discountInput.value : 0) || 0;
        const discounted = price * (1 - Math.max(0, Math.min(discount, 100)) / 100);
        if (priceWithDiscountEl) priceWithDiscountEl.value = formatMoney(discounted);
    }

    if (priceInput) priceInput.addEventListener('input', updatePriceWithDiscount);
    if (discountInput) discountInput.addEventListener('input', updatePriceWithDiscount);
    updatePriceWithDiscount();

    function attachDeleteHandlers(root = document) {
        root.querySelectorAll('.delete-img').forEach(btn => {
            if (btn._hasHandler) return;
            btn._hasHandler = true;
            btn.addEventListener('click', function() {
                const parentAttr = this.closest('.attribute-item');
                const parentImg = this.closest('.image-item');
                const parentAddonItem = this.closest('.addon-item');
                const parentNewPreview = this.closest('.new-addon-item-preview');
                if (parentAttr) parentAttr.remove();
                else if (parentImg) parentImg.remove();
                else if (parentAddonItem) parentAddonItem.remove();
                else if (parentNewPreview) parentNewPreview.remove();
            });
        });

        root.querySelectorAll('.remove-addon').forEach(btn => {
            if (btn._hasHandler) return;
            btn._hasHandler = true;
            btn.addEventListener('click', function() {
                const parentAddon = this.closest('.addon-category');
                if (parentAddon) parentAddon.remove();
            });
        });
    }

    attachDeleteHandlers();

    // Обработка превью для новых файлов существующих addon категорий
    document.querySelectorAll('.addon-file-input').forEach(input => {
        input.addEventListener('change', function() {
            const addonId = this.getAttribute('data-addon-id');
            const previewContainer = document.querySelector(`.new-addon-items-preview[data-addon-id="${addonId}"]`);
            if (!previewContainer) return;
            
            previewContainer.innerHTML = '';
            
            Array.from(this.files).forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'new-addon-item-preview';
                    div.innerHTML = `
                        <img src="${e.target.result}">
                        <input type="text" class="new-addon-item-name" data-index="${idx}" placeholder="Назва елемента">
                        <button type="button" class="delete-img">&times;</button>
                    `;
                    previewContainer.appendChild(div);
                    attachDeleteHandlers(div);
                };
                reader.readAsDataURL(file);
            });
        });
    });

    const addAttrBtn = document.getElementById('add-attribute');
    addAttrBtn.addEventListener('click', function() {
        const container = document.getElementById('attributes');
        const div = document.createElement('div');
        div.className = 'attribute-item';
        div.innerHTML = `<input type="text" name="attribute" value=""><button type="button" class="delete-img">&times;</button>`;
        container.appendChild(div);
        attachDeleteHandlers(div);
    });

    let newAddonCounter = 0;
    const newAddonsContainer = document.getElementById('new-addons-container');
    const addAddonBtn = document.getElementById('add-addon');

    addAddonBtn.addEventListener('click', function() {
        const idx = newAddonCounter++;
        const block = document.createElement('div');
        block.className = 'addon-category addon-category-new';
        block.setAttribute('data-new-index', idx);
        block.innerHTML = `
            <button type="button" class="remove-addon">Видалити</button>
            <h4>Нова доп.категорія</h4>
            <div class="form-group">
                <label>Назва</label>
                <input type="text" name="addon_name_new[]" value="">
            </div>
            <div class="form-group">
                <label>Ціна</label>
                <input type="number" step="0.01" name="addon_price_new[]" value="0">
            </div>
            <div class="form-group">
                <label>Елементи</label>
                <div class="addon-items" data-new-index="${idx}"></div>
                <input type="file" name="addon_items_new_${idx}" class="new-addon-file-input" data-new-index="${idx}" multiple accept="image/*">
                <div class="new-addon-items-preview" data-new-index="${idx}"></div>
            </div>
        `;
        newAddonsContainer.appendChild(block);
        attachDeleteHandlers(block);
        
        // Добавляем обработчик для новых файлов
        const fileInput = block.querySelector('.new-addon-file-input');
        fileInput.addEventListener('change', function() {
            const newIndex = this.getAttribute('data-new-index');
            const previewContainer = block.querySelector(`.new-addon-items-preview[data-new-index="${newIndex}"]`);
            if (!previewContainer) return;
            
            previewContainer.innerHTML = '';
            
            Array.from(this.files).forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'new-addon-item-preview';
                    div.innerHTML = `
                        <img src="${e.target.result}">
                        <input type="text" class="new-addon-item-name" data-index="${idx}" placeholder="Назва елемента">
                        <button type="button" class="delete-img">&times;</button>
                    `;
                    previewContainer.appendChild(div);
                    attachDeleteHandlers(div);
                };
                reader.readAsDataURL(file);
            });
        });
    });

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const fd = new FormData();

        const scalarFields = ['product-name','product-category','product-description','product-price','discount_percent'];
        scalarFields.forEach(name => {
            const el = document.getElementsByName(name)[0];
            if (el) fd.append(name, el.value);
        });

        const delPrev = document.querySelector('input[name="delete_preview"]');
        if (delPrev && delPrev.checked) fd.append('delete_preview', '1');

        document.querySelectorAll('input[name="existing_images"]').forEach(inp => {
            if (inp.value) fd.append('existing_images', inp.value);
        });

        const previewInput = document.querySelector('input[name="product-preview"]');
        if (previewInput && previewInput.files && previewInput.files.length > 0) {
            fd.append('product-preview', previewInput.files[0]);
        }

        const imagesInput = document.querySelector('input[name="product-images"]');
        if (imagesInput && imagesInput.files && imagesInput.files.length > 0) {
            Array.from(imagesInput.files).forEach(file => fd.append('product-images', file));
        }

        const attrInputs = Array.from(document.querySelectorAll('input[name="attribute"]'));
        const attrValues = attrInputs.map(i => i.value.trim()).filter(v => v.length > 0);
        fd.append('attributes', attrValues.join(';'));

        // Существующие addon категории
        document.querySelectorAll('.addon-category-existing').forEach(block => {
            const addonId = block.getAttribute('data-addon-id');
            if (!addonId) return;
            fd.append('existing_addon_category_ids', addonId);

            const nameEl = block.querySelector(`input[name="addon_name_${addonId}"]`);
            const priceEl = block.querySelector(`input[name="addon_price_${addonId}"]`);
            if (nameEl) fd.append(`addon_name_${addonId}`, nameEl.value);
            if (priceEl) fd.append(`addon_price_${addonId}`, priceEl.value);

            // ID существующих элементов
            block.querySelectorAll(`input[name="existing_addon_item_ids_${addonId}"]`).forEach(h => {
                if (h.value) fd.append(`existing_addon_item_ids_${addonId}`, h.value);
            });

            // Имена существующих элементов
            block.querySelectorAll(`input[name^="addon_item_name_${addonId}_"]`).forEach(inp => {
                fd.append(inp.name, inp.value);
            });

            // Новые файлы для существующей категории
            const fileInput = block.querySelector(`input[name="addon_items_${addonId}"]`);
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                Array.from(fileInput.files).forEach(f => fd.append(`addon_items_${addonId}`, f));
                
                // Собираем имена для новых файлов
                const previewContainer = block.querySelector(`.new-addon-items-preview[data-addon-id="${addonId}"]`);
                if (previewContainer) {
                    previewContainer.querySelectorAll('.new-addon-item-name').forEach(inp => {
                        fd.append(`addon_item_names_${addonId}[]`, inp.value || '');
                    });
                }
            }
        });

        // Новые addon категории
        document.querySelectorAll('.addon-category-new').forEach(block => {
            const newIndex = block.getAttribute('data-new-index');
            const nameEl = block.querySelector('input[name="addon_name_new[]"]');
            const priceEl = block.querySelector('input[name="addon_price_new[]"]');
            if (nameEl) fd.append('addon_name_new[]', nameEl.value);
            if (priceEl) fd.append('addon_price_new[]', priceEl.value);

            const fileInput = block.querySelector(`input[name="addon_items_new_${newIndex}"]`);
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                Array.from(fileInput.files).forEach(f => fd.append(`addon_items_new_${newIndex}`, f));
                
                // Собираем имена для новых файлов
                const previewContainer = block.querySelector(`.new-addon-items-preview[data-new-index="${newIndex}"]`);
                if (previewContainer) {
                    previewContainer.querySelectorAll('.new-addon-item-name').forEach(inp => {
                        fd.append(`addon_item_names_new_${newIndex}[]`, inp.value || '');
                    });
                }
            }
        });

        const actionUrl = form.getAttribute('action') || window.location.href;

        try {
            const resp = await fetch(actionUrl, {
                method: 'POST',
                body: fd,
            });

            if (resp.ok) {
                let data = null;
                try { data = await resp.json(); } catch (_) {}
                if (data && data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    window.location.reload();
                }
            } else {
                let text = await resp.text();
                alert('Ошибка при сохранении: ' + resp.status + '\n' + text);
            }
        } catch (err) {
            console.error(err);
            alert('Сетевая ошибка при отправке формы. Открой консоль для деталей.');
        }
    });
});
</script>

</body>
</html>