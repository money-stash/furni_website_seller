<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактирование товара</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-panel-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-products.css') }}">
    <style>
        .form-group { margin-bottom: 15px; }
        .form-group label { font-weight: bold; display: block; margin-bottom: 5px; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;
        }
        .preview-img { max-height: 150px; margin-bottom: 10px; display:block; }
        .additional-img { max-height: 100px; margin: 5px; display: block; }

        /* Default delete button style: used inside positioned containers */
        .delete-img { background: red; color: white; border: none; cursor: pointer; border-radius: 50%; width: 22px; height: 22px; line-height: 20px; text-align: center; font-size: 14px; }

        /* Attribute item: make it positioned so the absolute button sits next to the input */
        .attribute-item { display: flex; gap: 8px; margin-bottom: 6px; position: relative; align-items: center; }
        .attribute-item input { flex: 1; padding-right: 36px; }
        /* Place the delete button vertically centered at the right of the attribute input */
        .attribute-item .delete-img { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); }

        /* Image item: keep button in the top-right corner of the image */
        .image-item { position: relative; display: inline-block; margin: 5px; }
        .image-item .additional-img { max-height: 100px; display: block; }
        .image-item .delete-img { position: absolute; top: 4px; right: 4px; }
    </style>
</head>
<body>
<nav class="admin-nav">
    <a href="{{ url_for('admin.admin_panel') }}" class="nav-btn">Главное управление</a>
    <a href="{{ url_for('admin.admin_products') }}" class="nav-btn active">Управление товарами</a>
    <a href="{{ url_for('admin.admin_settings') }}" class="nav-btn">Настройки сайта</a>
</nav>

<div class="admin-container">
    <h1>Редактирование товара</h1>

    <form id="edit-product-form" method="POST" action="{{ url_for('products.update_product', product_id=product.id) }}" enctype="multipart/form-data">
        <div class="form-group">
            <label for="product-name">Название товара</label>
            <input type="text" name="product-name" id="product-name" value="{{ product.name }}">
        </div>

        <div class="form-group">
            <label for="product-category">Категория</label>
            <select name="product-category" id="product-category">
                <option value="">-- Без категории --</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if product.category and product.category.id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="product-description">Описание</label>
            <textarea name="product-description" id="product-description" rows="4">{{ product.description }}</textarea>
        </div>

        <div class="form-group">
            <label for="product-price">Цена</label>
            <input type="number" step="0.01" name="product-price" id="product-price" value="{{ product.price }}">
        </div>

        <div class="form-group">
            <label for="discount-percent">Скидка %</label>
            <input type="number" step="0.01" name="discount_percent" id="discount-percent" value="{{ product.discount_percent }}">
        </div>

        <!-- Итоговая цена со скидкой -->
        <div class="form-group">
            <label for="price-with-discount">Цена со скидкой</label>
            <input type="text" id="price-with-discount" readonly value="" />
        </div>

        <!-- Превью -->
        <div class="form-group">
            <label>Превью</label>
            {% if product.preview %}
                <img src="{{ url_for('static', filename=product.preview[7:] if product.preview.startswith('static/') else product.preview) }}" class="preview-img" id="current-preview">
                <!-- <label><input type="checkbox" name="delete_preview" value="1"> Удалить текущий превью</label> -->
            {% endif %}
            <input type="file" name="product-preview" accept="image/*">
        </div>

        <!-- Дополнительные изображения -->
        <div class="form-group">
            <label>Доп. изображения</label>
            <div id="additional-images">
                {% for img_path in product.images|map(attribute='path') %}
                    <div class="image-item">
                        <img src="{{ url_for('static', filename=img_path[7:] if img_path.startswith('static/') else img_path) }}" class="additional-img">
                        <button type="button" class="delete-img">&times;</button>
                        <input type="hidden" name="existing_images" value="{{ img_path }}">
                    </div>
                {% endfor %}
            </div>
            <input type="file" name="product-images" multiple accept="image/*">
        </div>

        <!-- Атрибуты -->
        <div class="form-group">
            <label>Атрибуты</label>
            <div id="attributes">
                {% for attr in attributes %}
                    <div class="attribute-item">
                        <input type="text" name="attribute" value="{{ attr }}">
                        <button type="button" class="delete-img">&times;</button>
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-attribute">Добавить атрибут</button>
        </div>

        <button type="submit" class="btn">Сохранить изменения</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('edit-product-form');

    // Calculate and display price after discount
    const priceInput = document.getElementsByName('product-price')[0];
    const discountInput = document.getElementsByName('discount_percent')[0];
    const priceWithDiscountEl = document.getElementById('price-with-discount');

    function formatMoney(val) {
        // format to 2 decimals and use dot as decimal separator
        return Number(val).toFixed(2);
    }

    function updatePriceWithDiscount() {
        const price = parseFloat(priceInput ? priceInput.value : 0) || 0;
        const discount = parseFloat(discountInput ? discountInput.value : 0) || 0;
        const discounted = price * (1 - Math.max(0, Math.min(discount, 100)) / 100);
        if (priceWithDiscountEl) priceWithDiscountEl.value = formatMoney(discounted);
    }

    // attach listeners
    if (priceInput) priceInput.addEventListener('input', updatePriceWithDiscount);
    if (discountInput) discountInput.addEventListener('input', updatePriceWithDiscount);

    // initial update
    updatePriceWithDiscount();

    // helper — attach delete handler to a .delete-img button inside an .attribute-item or .image-item
    function attachDeleteHandlers(root = document) {
        root.querySelectorAll('.delete-img').forEach(btn => {
            // avoid attaching twice
            if (btn._hasHandler) return;
            btn._hasHandler = true;
            btn.addEventListener('click', function() {
                const parentAttr = this.closest('.attribute-item');
                const parentImg = this.closest('.image-item');
                if (parentAttr) parentAttr.remove();
                else if (parentImg) parentImg.remove();
            });
        });
    }

    attachDeleteHandlers();

    // Add new attribute row
    const addBtn = document.getElementById('add-attribute');
    addBtn.addEventListener('click', function() {
        const container = document.getElementById('attributes');
        const div = document.createElement('div');
        div.className = 'attribute-item';
        div.innerHTML = `
            <input type="text" name="attribute" value="">
            <button type="button" class="delete-img">&times;</button>
        `;
        container.appendChild(div);
        attachDeleteHandlers(div);
    });

    // When submitting, build FormData explicitly so we control what is sent (files, existing images, attributes combined into one string, flags).
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const fd = new FormData();

        // Simple scalar fields
        const scalarFields = ['product-name','product-category','product-description','product-price','discount_percent'];
        scalarFields.forEach(name => {
            const el = document.getElementsByName(name)[0];
            if (el) fd.append(name, el.value);
        });

        // delete_preview checkbox
        const delPrev = document.querySelector('input[name="delete_preview"]');
        if (delPrev && delPrev.checked) fd.append('delete_preview', '1');

        // existing images (hidden inputs kept for images that remain)
        document.querySelectorAll('input[name="existing_images"]').forEach(inp => {
            if (inp.value) fd.append('existing_images', inp.value);
        });

        // Files: preview (single) and additional images (multiple)
        const previewInput = document.querySelector('input[name="product-preview"]');
        if (previewInput && previewInput.files && previewInput.files.length > 0) {
            fd.append('product-preview', previewInput.files[0]);
        }

        const imagesInput = document.querySelector('input[name="product-images"]');
        if (imagesInput && imagesInput.files && imagesInput.files.length > 0) {
            // append each file under same field name so Flask can read request.files.getlist('product-images')
            Array.from(imagesInput.files).forEach(file => fd.append('product-images', file));
        }

        // Attributes: collect all inputs with name="attribute" and join with semicolon
        const attrInputs = Array.from(document.querySelectorAll('input[name="attribute"]'));
        const attrValues = attrInputs.map(i => i.value.trim()).filter(v => v.length > 0);
        // join with semicolon as requested
        fd.append('attributes', attrValues.join(';'));

        // Include product id if present as part of the form's action URL — but also append as a field just in case
        const actionUrl = form.getAttribute('action') || window.location.href;
        // try to get product id from a hidden input or from action url. If there's a hidden input named product_id, include it.
        const prodIdEl = document.querySelector('input[name="product_id"]');
        if (prodIdEl && prodIdEl.value) fd.append('product_id', prodIdEl.value);

        // Send via fetch so files and form data go through
        try {
            const resp = await fetch(actionUrl, {
                method: 'POST',
                body: fd,
            });

            if (resp.ok) {
                // If server returns a redirect url in JSON, follow it; otherwise reload the page.
                // Try to parse json safely
                let data = null;
                try { data = await resp.json(); } catch (_) { /* not json */ }

                if (data && data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    // default: reload to reflect updates
                    window.location.reload();
                }
            } else {
                // try to read text and show alert
                let text = await resp.text();
                alert('Ошибка при сохранении: ' + resp.status + '\n' + text);
            }
        } catch (err) {
            console.error(err);
            alert('Сетевая ошибка при отправке формы. Открой консоль для деталей.');
        }
    });
});
</script>
</body>
</html>