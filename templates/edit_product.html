<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактирование товара</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-panel-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-products.css') }}">
    <style>
        .form-group { margin-bottom: 15px; }
        .form-group label { font-weight: bold; display: block; margin-bottom: 5px; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;
        }
        .preview-img { max-height: 150px; margin-bottom: 10px; display:block; }
        .additional-img { max-height: 100px; margin: 5px; position: relative; }
        .delete-img { position: absolute; top: 0; right: 0; background:red; color:white; border:none; cursor:pointer; border-radius:50%; width:22px; height:22px; line-height:20px; text-align:center; font-size:14px; }
        .attribute-item { display:flex; gap:8px; margin-bottom:6px; }
        .attribute-item input { flex:1; }
    </style>
</head>
<body>
<nav class="admin-nav">
    <a href="{{ url_for('admin_panel') }}" class="nav-btn">Главное управление</a>
    <a href="{{ url_for('admin_products') }}" class="nav-btn active">Управление товарами</a>
    <a href="{{ url_for('admin_settings') }}" class="nav-btn">Настройки сайта</a>
</nav>

<div class="admin-container">
    <h1>Редактирование товара</h1>

    <form id="edit-product-form" method="POST" action="{{ url_for('update_product', product_id=product.id) }}" enctype="multipart/form-data">
        <div class="form-group">
            <label for="product-name">Название товара</label>
            <input type="text" name="product-name" id="product-name" value="{{ product.name }}">
        </div>

        <div class="form-group">
            <label for="product-category">Категория</label>
            <select name="product-category" id="product-category">
                <option value="">-- Без категории --</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if product.category and product.category.id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="product-description">Описание</label>
            <textarea name="product-description" id="product-description" rows="4">{{ product.description }}</textarea>
        </div>

        <div class="form-group">
            <label for="product-price">Цена</label>
            <input type="number" step="0.01" name="product-price" id="product-price" value="{{ product.price }}">
        </div>

        <div class="form-group">
            <label for="discount-percent">Скидка %</label>
            <input type="number" step="0.01" name="discount_percent" id="discount-percent" value="{{ product.discount_percent }}">
        </div>

        <!-- Превью -->
        <div class="form-group">
            <label>Превью</label>
            {% if product.preview %}
                <img src="{{ url_for('static', filename=product.preview[7:] if product.preview.startswith('static/') else product.preview) }}" class="preview-img" id="current-preview">
                <label><input type="checkbox" name="delete_preview" value="1"> Удалить текущий превью</label>
            {% endif %}
            <input type="file" name="product-preview" accept="image/*">
        </div>

        <!-- Дополнительные изображения -->
        <div class="form-group">
            <label>Доп. изображения</label>
            <div id="additional-images">
                {% for img_path in product.images|map(attribute='path') %}
                    <div class="attribute-item">
                        <img src="{{ url_for('static', filename=img_path[7:] if img_path.startswith('static/') else img_path) }}" class="additional-img">
                        <button type="button" class="delete-img">&times;</button>
                        <input type="hidden" name="existing_images" value="{{ img_path }}">
                    </div>
                {% endfor %}
            </div>
            <input type="file" name="product-images" multiple accept="image/*">
        </div>

        <!-- Атрибуты -->
        <div class="form-group">
            <label>Атрибуты</label>
            <div id="attributes">
                {% for attr in attributes %}
                    <div class="attribute-item">
                        <input type="text" name="attribute" value="{{ attr }}">
                        <button type="button" class="delete-img">&times;</button>
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-attribute">Добавить атрибут</button>
        </div>

        <button type="submit" class="btn">Сохранить изменения</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Удаление доп. изображения
    document.querySelectorAll('.delete-img').forEach(btn => {
        btn.addEventListener('click', function() {
            const parent = this.closest('.attribute-item');
            parent.remove();
        });
    });

    // Добавление атрибутов
    const addBtn = document.getElementById('add-attribute');
    addBtn.addEventListener('click', function() {
        const container = document.getElementById('attributes');
        const div = document.createElement('div');
        div.className = 'attribute-item';
        div.innerHTML = `<input type="text" name="attribute" value="">
                         <button type="button" class="delete-img">&times;</button>`;
        container.appendChild(div);

        div.querySelector('.delete-img').addEventListener('click', () => div.remove());
    });
});
</script>
</body>
</html>